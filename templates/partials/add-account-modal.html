<!-- Add Account Modal -->
<div x-data="{ 
    show: false,
    loading: false,
    form: {
        email: '',
        password: '',
        username: '',
        imap_server: '',
        imap_port: 993,
        smtp_server: '',
        smtp_port: 587
    },
    error: '',
    init() {
        // Listen for open event
        window.addEventListener('open-add-account-modal', () => {
            this.show = true;
            this.resetForm();
        });
    },
    resetForm() {
        this.form = {
            email: '',
            password: '',
            username: '',
            imap_server: '',
            imap_port: 993,
            smtp_server: '',
            smtp_port: 587
        };
        this.error = '';
        this.loading = false;
    },
    async submit() {
        this.loading = true;
        this.error = '';

        try {
            const response = await fetch('/api/accounts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer {{.Token}}',
                    'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content
                },
                body: JSON.stringify({
                    email: this.form.email,
                    password: this.form.password,
                    username: this.form.username || this.form.email, // Default username to email if empty
                    imap_server: this.form.imap_server,
                    imap_port: parseInt(this.form.imap_port),
                    smtp_server: this.form.smtp_server,
                    smtp_port: parseInt(this.form.smtp_port)
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to add account');
            }

            // Success
            if (window.toastManager) {
                window.toastManager.show('Account added successfully', 'success');
            }
            this.show = false;
            
            // Reload page to show new account
            window.location.reload();

        } catch (e) {
            console.error('Add account error:', e);
            this.error = e.message;
            if (window.toastManager) {
                window.toastManager.show(e.message, 'error');
            }
        } finally {
            this.loading = false;
        }
    }
}" x-show="show" x-cloak class="fixed inset-0 z-[60] overflow-y-auto" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">

    <!-- Backdrop -->
    <div x-show="show" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200"
        x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
        class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="show = false"></div>

    <!-- Modal Panel -->
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

        <div x-show="show" x-transition:enter="ease-out duration-300"
            x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
            x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="ease-in duration-200"
            x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
            x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
            class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">

            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div
                        class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            Add New Account
                        </h3>

                        <!-- Error Display -->
                        <template x-if="error">
                            <div class="mt-2 text-sm text-red-600 bg-red-50 p-2 rounded">
                                <span x-text="error"></span>
                            </div>
                        </template>

                        <div class="mt-4 space-y-4">
                            <!-- Email -->
                            <div>
                                <label for="acc-email" class="block text-sm font-medium text-gray-700">Email
                                    Address</label>
                                <input type="email" id="acc-email" x-model="form.email"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border"
                                    placeholder="you@example.com">
                            </div>

                            <!-- Password -->
                            <div>
                                <label for="acc-password"
                                    class="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" id="acc-password" x-model="form.password"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border">
                            </div>

                            <!-- Username (Optional) -->
                            <div>
                                <label for="acc-username" class="block text-sm font-medium text-gray-700">Username
                                    (Optional)</label>
                                <input type="text" id="acc-username" x-model="form.username"
                                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border"
                                    placeholder="Defaults to email">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <!-- IMAP Server -->
                                <div class="col-span-2 sm:col-span-1">
                                    <label for="acc-imap" class="block text-sm font-medium text-gray-700">IMAP
                                        Server</label>
                                    <input type="text" id="acc-imap" x-model="form.imap_server"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border"
                                        placeholder="imap.example.com">
                                </div>
                                <!-- IMAP Port -->
                                <div class="col-span-2 sm:col-span-1">
                                    <label for="acc-imap-port"
                                        class="block text-sm font-medium text-gray-700">Port</label>
                                    <input type="number" id="acc-imap-port" x-model="form.imap_port"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border"
                                        placeholder="993">
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <!-- SMTP Server -->
                                <div class="col-span-2 sm:col-span-1">
                                    <label for="acc-smtp" class="block text-sm font-medium text-gray-700">SMTP
                                        Server</label>
                                    <input type="text" id="acc-smtp" x-model="form.smtp_server"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border"
                                        placeholder="smtp.example.com">
                                </div>
                                <!-- SMTP Port -->
                                <div class="col-span-2 sm:col-span-1">
                                    <label for="acc-smtp-port"
                                        class="block text-sm font-medium text-gray-700">Port</label>
                                    <input type="number" id="acc-smtp-port" x-model="form.smtp_port"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border"
                                        placeholder="587">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" @click="submit()"
                    :disabled="loading || !form.email || !form.password || !form.imap_server"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="loading" class="mr-2">
                        <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                    </span>
                    <span x-text="loading ? 'Adding...' : 'Add Account'"></span>
                </button>
                <button type="button" @click="show = false"
                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>