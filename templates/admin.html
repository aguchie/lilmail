{{define "admin"}}
<div class="h-[calc(100vh-64px)] flex flex-col overflow-hidden" x-data="{
    activeTab: 'users',
    users: [],
    stats: {},
    loading: false,
    async init() {
        await this.loadStats();
        await this.loadUsers();
    },
    async loadStats() {
        try {
            const response = await fetch('/api/admin/stats', {
                headers: {
                    'Authorization': 'Bearer {{.Token}}',
                    'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content
                }
            });
            if (response.ok) {
                this.stats = await response.json();
            }
        } catch (e) {
            console.error('Failed to load stats:', e);
        }
    },
    async loadUsers() {
        this.loading = true;
        try {
            const response = await fetch('/api/admin/users', {
                headers: {
                    'Authorization': 'Bearer {{.Token}}',
                    'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content
                }
            });
            if (response.ok) {
                const data = await response.json();
                this.users = data.users || [];
            }
        } catch (e) {
            console.error('Failed to load users:', e);
        } finally {
            this.loading = false;
        }
    },
    async createUser() {
        const username = prompt('{{t \" login_username\"}}:'); if (!username) return; const email=prompt('{{t
    \"login_email\"}}:'); if (!email) return; const password=prompt('{{t \"login_password\"}}:'); if (!password) return;
    try { const response=await fetch('/api/admin/users', { method: 'POST' , headers: { 'Content-Type'
    : 'application/json' , 'Authorization' : 'Bearer {{.Token}}' , 'X-CSRF-Token' :
    document.querySelector('meta[name=csrf-token]').content }, body: JSON.stringify({ username, email, password }) });
    if (response.ok) { await this.loadUsers(); window.dispatchEvent(new CustomEvent('show-toast', { detail: {
    type: 'success' , title: 'User created successfully' } })); } else { const data=await response.json(); throw new
    Error(data.error || 'Failed to create user' ); } } catch (e) { console.error('Error creating user:', e);
    window.dispatchEvent(new CustomEvent('show-toast', { detail: { type: 'error' , title: e.message } })); } }, async
    deleteUser(userId) { if (!confirm('{{t \"confirm_delete_email\"}}')) return; try { const response=await
    fetch(`/api/admin/users/${userId}`, { method: 'DELETE' , headers: { 'Authorization' : 'Bearer {{.Token}}'
    , 'X-CSRF-Token' : document.querySelector('meta[name=csrf-token]').content } }); if (response.ok) { await
    this.loadUsers(); window.dispatchEvent(new CustomEvent('show-toast', { detail: { type: 'success' ,
    title: 'User deleted' } })); } else { throw new Error('Failed to delete user'); } } catch (e) { console.error('Error
    deleting user:', e); window.dispatchEvent(new CustomEvent('show-toast', { detail: { type: 'error' , title: e.message
    } })); } }, async toggleUserRole(userId, currentRole) { const newRole=currentRole==='admin' ? 'user' : 'admin' ; try
    { const response=await fetch(`/api/admin/users/${userId}/role`, { method: 'PUT' , headers: { 'Content-Type'
    : 'application/json' , 'Authorization' : 'Bearer {{.Token}}' , 'X-CSRF-Token' :
    document.querySelector('meta[name=csrf-token]').content }, body: JSON.stringify({ role: newRole }) }); if
    (response.ok) { await this.loadUsers(); window.dispatchEvent(new CustomEvent('show-toast', { detail: {
    type: 'success' , title: 'Role updated' } })); } else { throw new Error('Failed to update role'); } } catch (e) {
    console.error('Error updating role:', e); window.dispatchEvent(new CustomEvent('show-toast', { detail: {
    type: 'error' , title: e.message } })); } } }">
    <!-- Header -->
    <div class="bg-white border-b px-6 py-4 flex-shrink-0">
        <h1 class="text-2xl font-semibold text-gray-900">{{t "nav_settings"}}</h1>
    </div>

    <!-- Stats Dashboard -->
    <div class="bg-gray-50 border-b px-6 py-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white rounded-lg p-4 shadow-sm">
                <div class="text-sm text-gray-600">Total Users</div>
                <div class="text-2xl font-bold text-gray-900" x-text="stats.total_users || 0"></div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm">
                <div class="text-sm text-gray-600">Active Accounts</div>
                <div class="text-2xl font-bold text-gray-900" x-text="stats.total_accounts || 0"></div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm">
                <div class="text-sm text-gray-600">Total Emails</div>
                <div class="text-2xl font-bold text-gray-900" x-text="stats.total_emails || 0"></div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm">
                <div class="text-sm text-gray-600">Total Drafts</div>
                <div class="text-2xl font-bold text-gray-900" x-text="stats.total_drafts || 0"></div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white border-b px-6">
        <div class="flex space-x-8">
            <button @click="activeTab = 'users'"
                :class="activeTab === 'users' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'"
                class="py-4 px-1 font-medium text-sm">
                User Management
            </button>
            <button @click="activeTab = 'settings'"
                :class="activeTab === 'settings' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'"
                class="py-4 px-1 font-medium text-sm">
                System Settings
            </button>
        </div>
    </div>

    <!-- Content -->
    <div class="flex-1 overflow-y-auto p-6">
        <!-- Users Tab -->
        <div x-show="activeTab === 'users'" class="max-w-6xl mx-auto">
            <div class="mb-6 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-900">Users</h2>
                <button @click="createUser()"
                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Create User
                </button>
            </div>

            <div x-show="loading" class="text-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            </div>

            <div x-show="!loading" class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Username</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Role</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Created</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="user in users" :key="user.id">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900" x-text="user.username"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-500" x-text="user.email"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span @click="toggleUserRole(user.id, user.role)"
                                        :class="user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'"
                                        class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full cursor-pointer hover:opacity-80"
                                        x-text="user.role"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <span x-text="new Date(user.created_at).toLocaleDateString()"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <button @click="deleteUser(user.id)"
                                        class="text-red-600 hover:text-red-900">Delete</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Settings Tab -->
        <div x-show="activeTab === 'settings'" class="max-w-4xl mx-auto">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">System Settings</h2>
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cache Settings</label>
                        <p class="text-sm text-gray-500">Cache is configured in config file</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Session Timeout</label>
                        <p class="text-sm text-gray-500">Session timeout is 24 hours</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email Retention</label>
                        <p class="text-sm text-gray-500">Emails are stored on the IMAP server</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{template "toast" .}}
</div>
{{end}}